name: Example SHA Sentry Usage

on:
  schedule:
    # Run every Sunday at midnight UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode'
        required: false
        default: false
        type: boolean
      create_pr:
        description: 'Create pull request instead of direct commit'
        required: false
        default: true
        type: boolean

permissions:
  contents: write
  pull-requests: write
  # Note: actions: write is NOT sufficient for workflow files

jobs:
  sha-pin-actions:
    runs-on: ubuntu-latest
    name: SHA Pin GitHub Actions
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Use PAT token for workflow file access
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 0
      
      - name: Run SHA Sentry (Primary Purpose - Workflow Files)
        id: sha_sentry
        uses: ./  # Use the action from current repository
        with:
          # REQUIRED: PAT with workflow permissions to process .github/workflows/
          github_token: ${{ secrets.PAT_TOKEN }}
          create_pr: ${{ github.event.inputs.create_pr || 'true' }}
          dry_run: ${{ github.event.inputs.dry_run || 'false' }}
          pr_title: '🔒 Security: SHA-pin GitHub Actions in Workflows'
          pr_body: |
            This pull request automatically SHA-pins all GitHub Actions in workflow files for enhanced security.
            
            ## 🛡️ Security Benefits
            - ✅ Prevents supply chain attacks via tag manipulation
            - ✅ Ensures reproducible builds with fixed commits
            - ✅ Follows GitHub security best practices
            
            ## 📊 Changes Made
            - **Files Updated**: ${{ steps.sha_sentry.outputs.files_updated }}
            - **Actions Pinned**: ${{ steps.sha_sentry.outputs.actions_pinned }}
            
            ## 🔍 What Was Pinned
            Examples of changes made:
            - `actions/checkout@v4` → `actions/checkout@8aca7672a9e6a874d8faa6b8f98a5212554c65cd`
            - `actions/setup-node@v4` → `actions/setup-node@1a4442cacd436585916779262731d5b162bc6ec7`
            
            ---
            *This PR was created automatically by [SHA Sentry](https://github.com/Tatsinnit/sha-sentry)*
          commit_message: '🔒 chore: SHA-pin GitHub Actions in workflows for enhanced security'
      
      - name: Print Summary
        if: always()
        run: |
          echo "## SHA Sentry Results 📊" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Changes Made**: ${{ steps.sha_sentry.outputs.changes_made }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Files Updated**: ${{ steps.sha_sentry.outputs.files_updated }}" >> $GITHUB_STEP_SUMMARY  
          echo "- **Actions Pinned**: ${{ steps.sha_sentry.outputs.actions_pinned }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.sha_sentry.outputs.pr_number }}" != "" ]; then
            echo "- **Pull Request**: #${{ steps.sha_sentry.outputs.pr_number }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.sha_sentry.outputs.changes_made }}" == "true" ]; then
            echo "✅ **Status**: Actions successfully pinned!" >> $GITHUB_STEP_SUMMARY
          else
            echo "ℹ️ **Status**: No changes needed - all actions already pinned" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Comment on PR (if created)
        if: steps.sha_sentry.outputs.pr_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.sha_sentry.outputs.pr_number }};
            const comment = `
            ## 🤖 SHA Sentry Report
            
            Successfully pinned **${{ steps.sha_sentry.outputs.actions_pinned }}** actions across **${{ steps.sha_sentry.outputs.files_updated }}** workflow files.
            
            ### What's Next?
            1. 👀 Review the changes in this PR
            2. ✅ Verify all pinned actions are from trusted sources  
            3. 🚀 Merge to apply the security improvements
            
            *This comment was generated automatically by SHA Sentry*
            `;
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });